
# Nmap The Basics 

## Overview:
Nmap is an open-source flexible network scanner that can be adapted to various scenarios and setups such as discover live hosts on a network and execute port scanning.

Note: Nmap is prefarably run as root `sudo` to prevent any restriction with Nmap’s abilities. Running Nmap as a local (non-root) user would limit us to fundamental types of scans such as ICMP echo and TCP connect scans

##  Target Specification
We need to identify the target to be scanned to discover live hosts in a network. There are three ways to discover live hosts:
- **IP Range**: Scan all the IP addresses in a certain range, this is done by using `-`  Eg:`192.168.0.1-10` scans all the IP addresses from 192.168.0.1 to 192.168.0.10.
- **Subnet**: Scan all the IP addresses in a certain subnet, this is done by using `/` Eg: `192.168.0.1/24` would be equivalent to 192.168.0.0-255
- **Hostname**: Use a domain name like `example.thm`.

## Discovering Live Hosts
- Nmap can be used to discover live hosts in a local network or remote network by using ping scan through the command `nmap -sn`. It aims to discover live hosts without attempting to discover the services running on them. This scan might be helpful to discover the devices on a network without causing much noise.
- Local network refers to the network we are directly connected to, such as an Ethernet or WiFi network. For directly connected networks (local network), Nmap sends ARP requests. When a device responds to the ARP request, Nmap labels it with “Host is up”.
- Remote network means that there consists of at least one router which separates our system from this network. For remote networks, ICMP or TCP/UDP requests are used by Nmap.

**Example: Scanning local network**

In the below diagram, `nmap -sn 192.168.66.0/24` scans the 192.168.66.0/24 network.

![image](https://github.com/user-attachments/assets/b6483073-1dd8-459f-9944-03074e3fb610)

Because we are scanning the local network, where we are connected via Ethernet or WiFi, we can look up the MAC addresses of the devices. Consequently, we can figure out the network card vendors, which is beneficial information as it can help us guess the type of target device(s).

**Example: Scanning remote network**

Our system has the IP address 192.168.66.89 and belongs to the 192.168.66.0/24 network. In the terminal below we scan the target network 192.168.11.0/24 where there are two or more routers (hops) separate our local system from the target hosts.

![image](https://github.com/user-attachments/assets/0d107cf0-3d7e-4ff6-8bb1-2f17cf1de051)

The Nmap output shows that five hosts are up but how did Nmap discover this? In the below diagram, we use Wireshark to examine the traffic generated by Nmap to discover the live hosts in a remote network. We can see the responses from two hosts:

- 192.168.11.1 is live and responded to the ICMP echo (ping) request.
- 192.168.11.2 seems down. Nmap sent two ICMP echo (ping) requests, two ICMP timestamp requests, two TCP packets to port 443 with the SYN flag set, and two TCP packets to port 80 with the ACK flag set. The target didn’t respond to any. We observe several ICMP destination unreachable packets from the 192.168.11.151 router.

![image](https://github.com/user-attachments/assets/37e24348-50e7-41fb-b3e3-7c3d8d54f7c4)

### Listing targets to be scanned without scanning
-  Nmap offers an option to **list targets to be scanned without actually scanning them** by using the option `nmap -sL`. This option helps confirm the targets before running the actual scan.
-  Example, `nmap -sL 192.168.0.1/24` will list the 256 targets that will be scanned. 

## Port Scanning
- As we mentioned earlier, ping scan, `nmap -sn` aims to discover live hosts without attempting to discover the services running on them. This scan might be helpful if we want to discover the devices on a network without causing much noise. However, this won’t tell us which services are running. If we want to learn more about the network services running on the live hosts, we need a more “noisy” type of scan.
- Common network services include web servers, which usually listen on TCP ports 80 and 443, and DNS servers, which typically listen on UDP (and TCP) port 53.

### Nmap Connect Scan
- In Nmap Connect Scan, it tries to complete the TCP three-way handshake with every target TCP port. If the TCP port is open and Nmap connects successfully, Nmap will tear down the established connection.
- Nmap connect scan can be conducted using `nmap -sT`

**Example:** 

- In the diagram below, our scanning machine has the IP address 192.168.124.148 and the target system has TCP port 22 open and port 23 closed. In the part marked with 1, we can see that the TCP three-way handshake was completed and later torn down with a TCP RST-ACK packet by Nmap.
- The part marked with 2 shows a connection attempt to port 23 which is closed. Hence, the target system responded with a TCP RST-ACK packet.

![image](https://github.com/user-attachments/assets/3c8820cc-11ec-4f1d-b6db-51f819242033)

### Nmap Stealth scan
- Unlike the connect scan, which tries to connect to the target's TCP port by completing a three-way handshake, the SYN scan only executes the first step by sending a TCP SYN packet. Consequently, the TCP three-way handshake is never completed.
- The advantage is that this is expected to lead to fewer logs as the connection is never established, and hence, it is considered a relatively stealthy scan.
- You can select the SYN scan using `nmap -sS`.

**Example:**

In the diagram below, we scan the same system with port 22 open. The part marked with 1 shows the listening service replying with a TCP SYN-ACK packet. However, Nmap responded with a TCP RST packet instead of completing the TCP three-way handshake. The part marked with 2 shows a TCP connection attempt to a closed port. In this case, the packet exchange is the same as in the connect scan.

![image](https://github.com/user-attachments/assets/4509210a-196f-4e5c-8642-ba3532712800)

### Scanning UDP Ports with Nmap
- Nmap also allows UDP Port scanning. UDP does not require establishing a connection and tearing it down afterwards. Furthermore, it is very suitable for real-time communication, such as live broadcasts. All these are reasons to consider scanning for and discovering services listening on UDP ports.
- Nmap offers the option `nmap -sU` to scan for UDP services.

**Example:** 

The screenshot below shows several ICMP destination unreachable (port unreachable) responses as Nmap sends UDP packets to closed UDP ports.

![image](https://github.com/user-attachments/assets/4a97c3b7-1b79-48b9-a80f-0ef154783a4b)

### Nmap Fast scanning
- By default, Nmap scans the most common 1,000 ports. However, it also supports fast scanning which scans the 100 most common ports
- `nmap -F` is used to initiate fast mode scanning

### Scanning a range of ports
- Besides scanning for common ports, Nmap also supports the ability to scan a range of ports
- `-p[range]` allows you to specify a range of ports to scan.
- Eg: `nmap -p10-1024` scans from port 10 to port 1024, while `nmap -p-25` will scan all the ports between 1 and 25.
-  `nmap -p-` scans all the ports and is equivalent to `nmap -p1-65535` and is the best option if you want to be as thorough as possible.

### Force scan
- When we run our port scan, such as using -sS, there is a possibility that the target host does not reply during the host discovery phase (e.g. a host doesn’t reply to ICMP requests). Consequently, Nmap will mark this host as down and won’t launch a port scan against it.
- We can ask Nmap to treat all hosts as online and port scan every host, including those that didn’t respond during the host discovery phase.
- This is done by adding the `-Pn` option. Eg: `nmap sS -Pn 192.168.124.211`

## OS, service and version detection
- **OS Detection (-O)**: Identifies operating system details.

  ![image](https://github.com/user-attachments/assets/5d6fc00f-a1d1-48c9-b414-20890c4d3b57)

- **Service and Version Detection (-sV)**: Detects versions of services on open ports. This is very convenient for gathering more information about your target with fewer keystrokes. 

  ![image](https://github.com/user-attachments/assets/dd67a603-0097-4055-a1e5-efd2475c2d22)

- **Aggressive Scan (-A)**: Combines OS detection, and service and version detection together.

## Controlling Scan Behavior
Nmap provides various options to control scan behavior by adjusting the scan speed and timing.

### Scan speed
- Running your scan at its normal speed might trigger an IDS or other security solutions. It is reasonable to control how fast a scan should go.
- Nmap gives you six timing templates, and the names say it all:  `paranoid (0)`, `sneaky (1)`, `polite (2)`, `normal (3)`, `aggressive (4)`, `insane (5)`. You can pick the timing template by its name or number. For example, you can add -T0 (or -T 0) or -T paranoid to opt for the slowest timing.

  ![image](https://github.com/user-attachments/assets/9aa38261-76cc-4ef1-bdff-79e812c9b563)

### Number of Parallel service probes
- By default, nmap will automatically control the number of parallel probes.
- The number of parallel probes can be controlled with `--min-parallelism` and `--max-parallelism`. These options can be used to set a minimum and maximum on the number of TCP and UDP port probes active simultaneously for a host group.

### Packet sending Rate
- Packet control rate controls the minimum and maximum rates at which nmap sends packets. The rate is provided as the number of packets per second. It is worth mentioning that the specified rate applies to the whole scan and not to a single host.
- `--min-rate` and `--max-rate` set packet sending rates.

### Host Timeout 
- **Host Timeout (--host-timeout)**: This option specifies the maximum time you are willing to wait, and it is suitable for slow hosts or hosts with slow network connections.

## Output configuration
- **Verbose Output (-v)**: Provides detailed progress. Levels: `-v`, `-vv`, `-vvvv`.
- **Debugging (-d)**: Enables detailed logs. Levels: `-d`, `-d9`.

## Saving Scan Results
- **Output Formats**:
  - `-oN <file>`: Normal human-readable format.
  - `-oX <file>`: XML format.
  - `-oG <file>`: Grepable format.
  - `-oA <base>`: Saves all formats.

## Summary of important Nmap commands

| Option                          | Description                                    |
|---------------------------------|------------------------------------------------|
| -sL                             | List targets without scanning                 |
| -sn                             | Ping scan – host discovery only               |
| -sT                             | TCP connect scan                              |
| -sS                             | TCP SYN scan                                  |
| -sU                             | UDP scan                                      |
| -F                              | Fast mode – scans top 100 common ports        |
| -p[range]                       | Specify port range (e.g., `-p1-65535`)        |
| -Pn                             | Treat all hosts as online                     |
| -O                              | OS detection                                  |
| -sV                             | Service version detection                     |
| -A                              | Aggressive scan                               |
| -T<0-5>                         | Timing template                               |
| --min-parallelism <numprobes>   | Minimum parallel probes                       |
| --max-parallelism <numprobes>   | Maximum parallel probes                       |
| --min-rate <number>             | Minimum packet rate                           |
| --max-rate <number>             | Maximum packet rate                           |
| --host-timeout <time>           | Set max time for a host                       |
| -v                              | Verbose output                                |
| -d                              | Debugging output                              |
| -oN <file>                      | Save in normal format                         |
| -oX <file>                      | Save in XML format                            |
| -oG <file>                      | Save in grepable format                       |
| -oA <base>                      | Save in all formats                           |
